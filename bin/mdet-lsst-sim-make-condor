#!/usr/bin/env python
import os
import numpy as np
import argparse
import shutil


CONDOR_SUBMIT_TEMPLATE = """

executable = run.sh
arguments = "$(SEED)"

# Image_Size =  2500000
request_memory = %(mem)s

getenv = True

kill_sig = SIGINT

should_transfer_files = YES
transfer_input_files = %(sim_config)s

# transfer when the job completes
when_to_transfer_output = ON_EXIT

notification = Never
environment = "OMP_NUM_THREADS=1"

+Experiment = "astro"
+job_name = "%(job_name)s"

queue SEED from (
%(seeds_str)s
)
"""


SCRIPT_TEMPLATE = r"""#!/usr/bin/bash

if [ $# -lt 1 ]; then
    echo "run.sh seed"
    exit 1
fi

set -e
export OMP_NUM_THREADS=1

seed=$1

%(command)s \
    --seed ${seed} \
    --config %(sim_config)s \
    --ntrial %(ntrial)d \
    --output "%(job_name)s-${seed}.fits.gz" &> /dev/null
"""


def copy_config_file(config_file):
    print('copying', config_file)
    shutil.copy(config_file, '.')


def write_script(job_name, main_seed, ntrial, sim_config, command):

    script_file = 'run.sh'

    print('writing:', script_file)
    with open(script_file, 'w') as fobj:
        text = SCRIPT_TEMPLATE % {
            'command': command,
            'job_name': job_name,
            'main_seed': main_seed,
            'ntrial': ntrial,
            'sim_config': sim_config,
        }
        fobj.write(text)

    os.system('chmod 755 %s' % script_file)


def get_command_from_config_file(config_file):
    import yaml
    with open(config_file) as fobj:
        config = yaml.load(fobj, Loader=yaml.SafeLoader)

    if config.get('do_photometry', False):
        command = 'mdet-lsst-sim-phot'
    else:
        command = 'mdet-lsst-sim'

    return command


def get_seeds_str(rng, njobs):
    seeds = rng.choice(2**30, size=njobs)
    seed_strs = [str(seed) for seed in seeds]
    return '\n'.join(seed_strs)


def get_args():
    parser = argparse.ArgumentParser()
    parser.add_argument('--run', required=True)
    parser.add_argument('--seed', type=int, required=True, help='seed for rng')
    parser.add_argument('--njobs', type=int, required=True)
    parser.add_argument('--ntrial', type=int, required=True,
                        help='number of sim pairs to run for each job')
    parser.add_argument('--config', required=True, help='config file')

    parser.add_argument('--mem', default='1.5G', help='expected mem usage')

    return parser.parse_args()


def main(args):

    job_name = f'{args.run}-{args.seed:d}'
    condor_file = f'{job_name}.condor'

    if os.path.exists(condor_file):
        raise RuntimeError('script already exists: %s' % condor_file)

    command = get_command_from_config_file(args.config)

    copy_config_file(args.config)
    sim_config_local = os.path.basename(args.config)

    rng = np.random.RandomState(args.seed)
    seeds_str = get_seeds_str(rng=rng, njobs=args.njobs)

    write_script(
        job_name=job_name,
        main_seed=args.seed,
        ntrial=args.ntrial,
        sim_config=sim_config_local,
        command=command,
    )

    text = CONDOR_SUBMIT_TEMPLATE % {
        'sim_config': sim_config_local,
        'mem': args.mem,
        'job_name': job_name,
        'seeds_str': seeds_str,
    }

    print('writing', args.njobs, 'jobs to', condor_file)
    with open(condor_file, 'w') as fobj:
        fobj.write(text)


if __name__ == '__main__':
    main(args=get_args())
